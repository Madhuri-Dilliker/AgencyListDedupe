---
title: "Dedupe Resource List"
output: html_notebook
---

```{r libraries, include=FALSE}
library(tidyverse)
```


# Purpose 
Dedupe Resource Lists for Covid and resource directory.

The plan is to first dedupe the Organization names and create an Org ID. Then use Org ID and Program name to dedupe programs.



# Prework

Ran both lists of data "Master-Agency-Finder" and "ResourcesCovid" though OpenRefine and clustered the org names. 



```{r Import data, include=FALSE}
resources <- read_csv("data/MasterList-Agency-Finder.csv")

covid_res <- read_csv("data/ResourcesCOVID.csv")
```



Rename first column of resources to identify data.

```{r}
resources <- rename(resources, 'MSheetID' = 'Column'  )
```


Combine two sheets into one dataframe for preparation in the Dedupe of Orgs.

Step1: shorten dataframes into only the necessary columns for the dedupe of orgs.


```{r}
covid_res.df <- select(covid_res, CSheetID, Org, 'Program Name', 'Street Address', City, Zip )

covid_res.df <- rename(covid_res.df, c('ID' = 'CSheetID', 'Org' = 'Org', 'Program' = 'Program Name','Street' ='Street Address'))
```




```{r}
resources.df <- select(resources, MSheetID, `Organization Name`, 'Program Name', 'Street Address', City, Zip)

resources.df<- rename(resources.df, c('ID' = 'MSheetID', 'Org' = 'Organization Name', 'Program' = 'Program Name', 'Street' = 'Street Address' ))
```


Step2: combine table rows

```{r}
comb_res <- bind_rows( covid_res.df, resources.df)
```

Replace error with zip endding in '.0'

```{r}
comb_res <- comb_res %>% 
  mutate(Zip= str_remove(Zip, "\\.0"))
```




export file out
```{r}
write_csv(comb_res, "data/comb_res.csv")
```



import clusters from dedupe Step

```{r}
program_clusters <- read_csv("data/Org Resource List.csv")
```



Add Cluster Ids to resource columns
```{r}
# create df's to store new tables

resources.Clustered <- resources

covid_res.clustered <- covid_res

```



create joining table
```{r}
cluster_join <- select(program_clusters, cluster_id, id)
```


left joins
```{r}
resources.Clustered <- left_join(resources.Clustered, cluster_join, by= c('MSheetID'= 'id'))

#relocate joined cluster column to position 2
resources.Clustered <- resources.Clustered %>% 
  relocate(cluster_id, .after = MSheetID)
```

```{r}
covid_res.clustered<- left_join(covid_res.clustered, cluster_join, by = c("CSheetID"='id'))


# relocate cluster id column to position 2
covid_res.clustered <- covid_res.clustered %>% 
  relocate(cluster_id, .after = CSheetID)

```



Count number of distinct programs
```{r}
n_distinct(cluster_join$cluster_id)

```

```{r}
n_distinct(covid_res.clustered$cluster_id)

n_distinct(resources.Clustered$cluster_id)
```

```{r}
covid.unique<- as_tibble(  unique(covid_res.clustered$cluster_id))

resources.unique <- as_tibble(unique(resources.Clustered$cluster_id))
```


```{r}
nonJoinCR <- anti_join(covid.unique, resources.unique)

nonJoinRC <- anti_join(resources.unique, covid.unique)
```


```{r}
explore_covid <-filter(covid_res.clustered, cluster_id %in% nonJoinCR$value)
```

```{r}
explore_res <- filter(resources.Clustered, cluster_id %in% nonJoinRC$value)
```


```{r}
filter(explore_covid, Org != 'Guilford County Schools')
```


Will add 17 programs from Covid resource list to master resource list.


Then extract orgs from that list.


Extract Service types from that unique list as well.



